#include "uart_protocol.h"
#include "hal_defs.h"


static uint8_t frameHeader[]={0x01,0x23,0x45,0x67,0x89,0xAB,0xCD,0xEF,0xAA,0xBB};
static uint8_t frameHip[]={0xBB,0xAA,0xFE,0xDC,0xBA,0x98,0x76,0x54,0x32,0x10};
uint8_t heartRateDataFrameSample[]=
{
/*
 <01234567 89abcdef aabb//header
 	8100 //frame data length in bytes
 	47fba10a 4a010000>,//start time
    <01// first data type
    47fba1 0a4a0100 00 // first start time
    f401//first period
    0200//first length
    3c00//first data
    02//second data type
    47fba10a>, <4a010000 //sec start time
    3200//sec period
    2800 //sec length
    bf550300 f59e0c00 3d6a0100>,//sec data 40bytes
    <84350200 988c0c00 b8140f00 dfa10000 fdbd0100>,
    <4ffc0a00 2e510400 
    03//third data type
    47fba1 0a4a0100 00//third start time
    3200//third period
    28>,    <00//third length
    307500 00307500 00307500 00307500 00307500>,//third data 40 bytes
    <00307500 00307500 00307500 00307500 00307500>,
    <00
    bbaafe dcba9876 543210//hip
    01>//checksum
    */
	0x01,0x23,0x45,0x67,0x89,0xab,0xcd,0xef,0xaa,0xbb,//header
	0x81,0x00,//frame data length in bytes
	0x47,0xfb,0xa1,0x0a,0x4a,0x01,0x00,0x00,//start time
	0x01,// first data type
	0x47,0xfb,0xa1,0x0a,0x4a,0x01,0x00,0x00, // first start time
	0xf4,0x01,//first period
	0x02,0x00,//first length
	0x3c,0x00,//first data
	0x02,//second data type
	0x47,0xfb,0xa1,0x0a,0x4a,0x01,0x00,0x00,//sec start time
	0x32,0x00,//sec period
	0x28,0x00,//sec length
	0xbf,0x55,0x03,0x00,0xf5,0x9e,0x0c,0x00,0x3d,0x6a,0x01,0x00,//sec data 40bytes
	0x84,0x35,0x02,0x00,0x98,0x8c,0x0c,0x00,0xb8,0x14,0x0f,0x00,0xdf,0xa1,0x00,0x00,0xfd,0xbd,0x01,0x00,
	0x4f,0xfc,0x0a,0x00,0x2e,0x51,0x04,0x00,
	0x03,//third data type
	0x47,0xfb,0xa1,0x0a,0x4a,0x01,0x00,0x00,//third start time
	0x32,0x00,//third period
	0x28,0x00,//third length
	0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,//third data 40 bytes
	0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,
	0x00,
	0xbb,0xaa,0xfe,0xdc,0xba,0x98,0x76,0x54,0x32,0x10,//hip
	0x01//checksum
};

uint8_t heartRateDataPackageSample[]=
{
//	0x01,0x23,0x45,0x67,0x89,0xab,0xcd,0xef,0xaa,0xbb,//header
//	0x81,0x00,//frame data length in bytes
	0x47,0xfb,0xa1,0x0a,0x4a,0x01,0x00,0x00,//start time
	0x01,// first data type
	0x47,0xfb,0xa1,0x0a,0x4a,0x01,0x00,0x00, // first start time
	0xf4,0x01,//first period
	0x02,0x00,//first length
	0x3c,0x00,//first data
	0x02,//second data type
	0x47,0xfb,0xa1,0x0a,0x4a,0x01,0x00,0x00,//sec start time
	0x32,0x00,//sec period
	0x28,0x00,//sec length
	0xbf,0x55,0x03,0x00,0xf5,0x9e,0x0c,0x00,0x3d,0x6a,0x01,0x00,//sec data 40bytes
	0x84,0x35,0x02,0x00,0x98,0x8c,0x0c,0x00,0xb8,0x14,0x0f,0x00,0xdf,0xa1,0x00,0x00,0xfd,0xbd,0x01,0x00,
	0x4f,0xfc,0x0a,0x00,0x2e,0x51,0x04,0x00,
	0x03,//third data type
	0x47,0xfb,0xa1,0x0a,0x4a,0x01,0x00,0x00,//third start time
	0x32,0x00,//third period
	0x28,0x00,//third length
	0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,//third data 40 bytes
	0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,0x00,0x30,0x75,0x00,
	0x00
//	0xbb,0xaa,0xfe,0xdc,0xba,0x98,0x76,0x54,0x32,0x10,//hip
//	0x01//checksum
};

uint8_t *pHRD=heartRateDataPackageSample;

frame_data_t *framePackage(package_data_t *packageData)
{
	frame_data_t *pFrameData;
	uint8_t checksum=0;
	uint8_t *pDataTemp;
	
	pFrameData->pHeader=frameHeader;
	pFrameData->length=packageData->length+23;
	pFrameData->pData=packageData->pData;
	pFrameData->pHip=frameHip;
	pDataTemp=packageData->pData;
	for(uint8_t i=0;i<packageData->length;i++)
	{
		checksum+=*pDataTemp;
		pDataTemp++;
	}
	checksum+=HI_UINT16( packageData->length);
	checksum+=LO_UINT16( packageData->length);
	pFrameData->checksum=checksum;

	return pFrameData;
}

package_data_t *frameUnPackage(frame_data_t *frameData)
{
	package_data_t *pPackageData;
	uint8_t checksum=0;
	uint8_t *pDataTemp;
	
	pPackageData->pData=frameData->pData;
	pPackageData->length=frameData->length-23;
	pDataTemp=frameData->pData;
	for(uint8_t i=0;i<pPackageData->length;i++)
		{
		checksum+=*pDataTemp;
		pDataTemp++;
	}
	checksum+=HI_UINT16(frameData->length);
	checksum+=LO_UINT16(frameData->length);
	if(checksum==frameData->checksum)
	{	
		return pPackageData;
	}
	else
	{
		return NULL;
	}
}

